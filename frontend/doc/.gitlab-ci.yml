image: docker:dind

stages:
  - build
  - deploy_staging
  - deploy_prod
  - cleanup

variables:
  DOCKER_DRIVER: overlay2

  CI_REGISTRY: harbor.cxview.local
  CONTAINER_PROJECT: cxview/aicv-dashboard
  CONTAINER_IMAGE: $CI_REGISTRY/$CONTAINER_PROJECT
  COMMIT_SHA: $CI_COMMIT_SHORT_SHA

  # Staging
  STAGE_NAMESPACE: cxview-staging
  STAGE_RELEASE_NAME: aicv-dashboard-staging
  STAGE_DOMAIN_NAME: portal.cxview.local
  CHART_PATH_STAGING: ./charts/staging
  TAG_STAGING: staging-$COMMIT_SHA

  # Production
  PROD_NAMESPACE: cxview-production
  PROD_RELEASE_NAME: aicv-dashboard-prod
  PROD_DOMAIN_NAME: portal.cxview.ai
  CHART_PATH_PROD: ./charts/prod
  TAG_PROD: prod-$COMMIT_SHA

before_script:
  - echo "Deploy AICV Dashboard"
  - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"

# ==============================
# 1) Build Docker Image (staging + prod tags)
# ==============================
build:
  stage: build
  tags: [k8s-prod]
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
      when: on_success
    - when: never
  script:
    - echo "Building staging image $CONTAINER_IMAGE:$TAG_STAGING ..."
    - docker build --pull -t $CONTAINER_IMAGE:$TAG_STAGING .
    - docker push $CONTAINER_IMAGE:$TAG_STAGING

    - echo "Tagging prod image $CONTAINER_IMAGE:$TAG_PROD ..."
    - docker tag $CONTAINER_IMAGE:$TAG_STAGING $CONTAINER_IMAGE:$TAG_PROD
    - docker push $CONTAINER_IMAGE:$TAG_PROD

# ==============================
# 2) Deploy Staging (Automatic)
# ==============================
deploy_staging:
  stage: deploy_staging
  tags: [k8s-prod]
  needs: ["build"]
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
      when: on_success
    - when: never
  script:
    - echo "Deploying staging..."
    - apk add --no-cache helm bash
    - >
      helm upgrade --install $STAGE_RELEASE_NAME $CHART_PATH_STAGING
      --set image.repository=$CONTAINER_IMAGE
      --set image.tag=$TAG_STAGING
      --set image.pullPolicy=Always
      --set ingress.enabled=true
      --set ingress.hosts[0]=$STAGE_DOMAIN_NAME
      --set ingress.tls[0].hosts[0]=$STAGE_DOMAIN_NAME
      --set ingress.tls[0].secretName=$STAGE_DOMAIN_NAME
      --set service.port="5080"
      --wait
      --namespace=$STAGE_NAMESPACE
  environment:
    name: staging
    url: https://$STAGE_DOMAIN_NAME

# ==============================
# 3) Deploy Production (Manual)
# ==============================
deploy_prod:
  stage: deploy_prod
  tags: [k8s-prod]
  when: manual
  needs:
    - job: build
      optional: true
  script:
    - echo "Deploying production..."
    - apk add --no-cache helm bash
    - >
      helm upgrade --install $PROD_RELEASE_NAME $CHART_PATH_PROD
      --set image.repository=$CONTAINER_IMAGE
      --set image.tag=$TAG_PROD
      --set image.pullPolicy=Always
      --set ingress.enabled=true
      --set ingress.hosts[0]=$PROD_DOMAIN_NAME
      --set ingress.tls[0].hosts[0]=$PROD_DOMAIN_NAME
      --set ingress.tls[0].secretName=$PROD_DOMAIN_NAME
      --set service.port="5080"
      --wait
      --namespace=$PROD_NAMESPACE
  environment:
    name: production
    url: https://$PROD_DOMAIN_NAME

# ==============================
# 4) Cleanup
# ==============================
cleanup:
  stage: cleanup
  tags: [k8s-prod]
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
      when: on_success
  script:
    - docker system prune -af
    - echo "Cleanup complete."
